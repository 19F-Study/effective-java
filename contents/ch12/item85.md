# Item87. 자바 직렬화의 대안을 찾으라  
  
  
## 객체 직렬화  
- 1997년 자바에 처음 도입된 객체 직렬화 개념은, 자바가 객체를 바이트 스트림으로 인코딩하고(직렬화) 그 바이트 스트림으로부터 다시 객체를 재구성하는(역직렬화) 메커니즘이다.  
- 주로 직렬화된 객체는 다른 자바 시스템(또는 JVM)에서 역직렬화하여 사용한다.  
- 프로그래머가 어렵지 않게 분산 객체를 만들 수 있다는 점은 매력적이었지만, 그 대가가 너무 컸다.  
  
  
> 분산 객체 (Distributed Object) 란? [^1]  
> - 분산 컴퓨팅 기술이 객체 지향과 접목되어 하나의 프로세서나 컴퓨터에서 실행되는 객체가 다른 프로세서나 컴퓨터에서 객체와 통신이 가능 하도록 하는 기술이 분산 객체 기술.  
> - 자바에서는 대표적으로 RMI(Remote Method Invocation)가 있다.   

<br>

## 직렬화의 문제점  
**심각한 보안 문제!**
- 직렬화를 위해 Serializable 인터페이스를 구현한 객체는 readObject 메서드를 가지고 있는데, 이 메서드는 클래스패스 안의 거의 모든 타입의 객체를 만들어낼 수 있다. 즉, 바이트 스트림을 역직렬화하는 과정에서 이 메서드는 그 타입들 안의 모든 코드를 수행할 수 있다는 뜻이다. 이 말인즉슨, 그 타입들의 코드 전체가 공격 범위에 들어간다는 뜻이다.  
- tip) 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행한느 메서드들을 가젯(gadget) 이라 부른다.
> 신뢰할 수 없는 바이트 스트림을 역직렬화하면 원격 코드 실행 (Remote Code Execution, RCE), 서비스 거부(Denial-of-Service, DoS) 등의 공격으로 이어질 수 있다. - Robert Seacord, CERT
  
<br>

**deserialization bomb!**
- 역직렬화에 시간에 오래 걸리는 짧은 스트림.
- 이 스트림을 직렬화하는 것만으로도 DoS 에 쉽게 노출될 수 있다.
```java
static byte[] bomb() {  
  Set<Object> root = new HashSet<>();  
  Set<Object> s1 = root;  
  Set<Object> s2 = new HashSet<>();  
  for (int i = 0; i < 100; i++) {  
    Set<Object> t1 = new HashSet<>();  
    Set<Object> t2 = new HashSet<>();  
    t1.add("foo"); // make it not equal to t2  
    s1.add(t1); s1.add(t2);  
    s2.add(t1); s2.add(t2);
    s1 = t1;  
    s2 = t2;  
  }  
  return serialize(root);  
}
```
위 예제에서 직렬화된 root의 크기는 5,774 바이트지만, 역직렬화는 영원히 끝나지 않을 것이다. 그 이유는 HashSet 인스턴스를 역직렬화하려면 그 원소들의 해시코드를 계산해야 한다는 데 있다. 따라서, 역직렬화하려면 hashCode 메서드를 2의 100승번 넘게 호출해야 한다..

<br>

## 대안을 찾으라
- 직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.
  -  우리가 앞으로 작성할 새로운 시스템에서 자바 직렬화를 써야 할 이유는 전.혀. 없다. 객체와 바이트 시퀀스를 변환해주는 다른 메커니즘이 많이 있기 때문이다. e.g) json, protocol buffer
- 레거지 시스템 때문에 자바 직렬화를 완전히 배제할 수 없을 때의 차선책은 신뢰할 수 없는 데이터는 절대 역직렬화하지 않는 것이다. 자바의 공식 보안 코딩 지침에도 '신뢰할 수 없는 데이터의 역직렬화는 본질적으로 위험하므로 절대로 피해야 한다' 라고 조언하고 있다.
- 직렬화를 피할 수 없고 역직렬화한 데이터가 안전한지 확신할 수 없다면 객체 역직렬화 필터링(java.io.ObjectInputFilter)을 사용하자.
  - 데이터 스트림이 역직렬화되기 전에 필터를 설치하는 기능.
  - 특정 클래스를 받아들이거나 거부할 수 있다.
  - '기본 수용' 모드에서는 블랙리스트에 기록된 잠재적으로 위험한 클래스들을 거부한다.
  - '기본 거부' 모드에서는 화이트리스트에 기록된 안전하다고 알려진 클래스들만 수용한다.

<br>

## 핵심 정리
- 직렬화는 위험하니 피해야 한다.
- 처음부터 시스템을 설계한다면 JSON이나 protocol buffer같은 대안을 사용하자.
- 신뢰할 수 없는 데이터는 역직렬화하지 말자. 해야한다면 역직렬화 필터링을 사용하되, 이마저도 모든 공격을 막아줄 수는 없음을 기억하자.
- 클래스가 직렬화를 지원하도록 만들지 말고, 꼭 그렇게 만들어야 한다면 정말 신경써서 작성해야 한다.
  
<br><br><br><hr>  
      
[^1]: [분산 객체](http://ojc.asia/bbs/board.php?bo_table=LecJavaNet&wr_id=12)